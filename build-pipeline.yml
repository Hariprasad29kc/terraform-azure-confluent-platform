trigger:
- master
- develop

pool: Default
#container: devopsinfra/docker-terragrunt

stages:
- stage: Build
  displayName: 'Build Terraform artifact'
  jobs:
  - job: copy_artifacts
    steps:
      - task: CopyFiles@2
        displayName: 'Copy application gateway module'
        inputs:
          SourceFolder: '.'
          TargetFolder: '$(build.artifactstagingdirectory)'
  - job: publish_artifacts
    steps:
      - task: CopyFiles@2
        displayName: 'Copy application gateway module'
        inputs:
          SourceFolder: '.'
          TargetFolder: '$(build.artifactstagingdirectory)'
- stage: ResourceGroup
  displayName: 'Resource Group'
  dependsOn: build
  jobs:
    - job: terraform_plan
      steps:
        - script: |
            cd production/resource_group
            terragrunt plan
          displayName: 'terraform plan'
    - job: waitForValidation
      dependsOn: terraform_plan
      displayName: Wait for external validation
      pool: server
      timeoutInMinutes: 4320 # job times out in 3 days
      steps:
        - task: ManualValidation@0
          timeoutInMinutes: 1440 # task times out in 1 day
          inputs:
            notifyUsers: |
              mccullya@gmail.com
            instructions: 'Please validate the build configuration and resume'
            onTimeout: 'reject'
    - job: terraform_apply
      dependsOn: waitForValidation
      steps:
        - script: |
            cd production/resource_group
            terragrunt apply -auto-approve
          displayName: 'terraform apply'
- stage: Broker
  displayName: 'Broker'
  dependsOn: build
  jobs:
    - job: terraform_plan
      steps:
        - script: |
            cd production/broker
            terragrunt plan
          displayName: 'terraform plan'
    - job: waitForValidation
      dependsOn: terraform_plan
      displayName: Wait for external validation
      pool: server
      timeoutInMinutes: 4320 # job times out in 3 days
      steps:
        - task: ManualValidation@0
          timeoutInMinutes: 1440 # task times out in 1 day
          inputs:
            notifyUsers: |
              mccullya@gmail.com
            instructions: 'Please validate the build configuration and resume'
            onTimeout: 'reject'
    - job: terraform_apply
      dependsOn: waitForValidation
      steps:
        - script: |
            cd production/broker
            terragrunt apply -auto-approve
          displayName: 'terraform apply'
- stage: Zookeeper
  displayName: 'Zookeeper'
  dependsOn: build
  jobs:
    - job: terraform_plan
      steps:
        - script: |
            cd production/zookeeper
            terragrunt plan
          displayName: 'terraform plan'
    - job: waitForValidation
      dependsOn: terraform_plan
      displayName: Wait for external validation
      pool: server
      timeoutInMinutes: 4320 # job times out in 3 days
      steps:
        - task: ManualValidation@0
          timeoutInMinutes: 1440 # task times out in 1 day
          inputs:
            notifyUsers: |
              mccullya@gmail.com
            instructions: 'Please validate the build configuration and resume'
            onTimeout: 'reject'
    - job: terraform_apply
      dependsOn: waitForValidation
      steps:
        - script: |
            cd production/zookeeper
            terragrunt apply -auto-approve
          displayName: 'terraform apply'
- stage: SchemaRegistry
  displayName: 'SchemaRegistry'
  dependsOn: build
  jobs:
    - job: terraform_plan
      steps:
        - script: |
            cd production/schema_registry
            terragrunt plan
          displayName: 'terraform plan'
    - job: waitForValidation
      dependsOn: terraform_plan
      displayName: Wait for external validation
      pool: server
      timeoutInMinutes: 4320 # job times out in 3 days
      steps:
        - task: ManualValidation@0
          timeoutInMinutes: 1440 # task times out in 1 day
          inputs:
            notifyUsers: |
              mccullya@gmail.com
            instructions: 'Please validate the build configuration and resume'
            onTimeout: 'reject'
    - job: terraform_apply
      dependsOn: waitForValidation
      steps:
        - script: |
            cd production/schema_registry
            terragrunt apply -auto-approve
          displayName: 'terraform apply'
- stage: RestProxy
  displayName: 'RestProxy'
  dependsOn: build
  jobs:
    - job: terraform_plan
      steps:
        - script: |
            cd production/rest_proxy
            terragrunt plan
          displayName: 'terraform plan'
    - job: waitForValidation
      dependsOn: terraform_plan
      displayName: Wait for external validation
      pool: server
      timeoutInMinutes: 4320 # job times out in 3 days
      steps:
        - task: ManualValidation@0
          timeoutInMinutes: 1440 # task times out in 1 day
          inputs:
            notifyUsers: |
              mccullya@gmail.com
            instructions: 'Please validate the build configuration and resume'
            onTimeout: 'reject'
    - job: terraform_apply
      dependsOn: waitForValidation
      steps:
        - script: |
            cd production/rest_proxy
            terragrunt apply -auto-approve
          displayName: 'terraform apply'
- stage: KafkaConnect
  displayName: 'KafkaConnect'
  dependsOn: build
  jobs:
    - job: terraform_plan
      steps:
        - script: |
            cd production/kafka_connect
            terragrunt plan
          displayName: 'terraform plan'
    - job: waitForValidation
      dependsOn: terraform_plan
      displayName: Wait for external validation
      pool: server
      timeoutInMinutes: 4320 # job times out in 3 days
      steps:
        - task: ManualValidation@0
          timeoutInMinutes: 1440 # task times out in 1 day
          inputs:
            notifyUsers: |
              mccullya@gmail.com
            instructions: 'Please validate the build configuration and resume'
            onTimeout: 'reject'
    - job: terraform_apply
      dependsOn: waitForValidation
      steps:
        - script: |
            cd production/kafka_connect
            terragrunt apply -auto-approve
          displayName: 'terraform apply'
- stage: KSQL
  displayName: 'KSQL'
  dependsOn: build
  jobs:
    - job: terraform_plan
      steps:
        - script: |
            cd production/ksql
            terragrunt plan
          displayName: 'terraform plan'
    - job: waitForValidation
      dependsOn: terraform_plan
      displayName: Wait for external validation
      pool: server
      timeoutInMinutes: 4320 # job times out in 3 days
      steps:
        - task: ManualValidation@0
          timeoutInMinutes: 1440 # task times out in 1 day
          inputs:
            notifyUsers: |
              mccullya@gmail.com
            instructions: 'Please validate the build configuration and resume'
            onTimeout: 'reject'
    - job: terraform_apply
      dependsOn: waitForValidation
      steps:
        - script: |
            cd production/ksql
            terragrunt apply -auto-approve
          displayName: 'terraform apply'
- stage: ControlCentre
  displayName: 'ControlCentre'
  dependsOn: build
  jobs:
    - job: terraform_plan
      steps:
        - script: |
            cd production/control_centre
            terragrunt plan
          displayName: 'terraform plan'
    - job: waitForValidation
      dependsOn: terraform_plan
      displayName: Wait for external validation
      pool: server
      timeoutInMinutes: 4320 # job times out in 3 days
      steps:
        - task: ManualValidation@0
          timeoutInMinutes: 1440 # task times out in 1 day
          inputs:
            notifyUsers: |
              mccullya@gmail.com
            instructions: 'Please validate the build configuration and resume'
            onTimeout: 'reject'
    - job: terraform_apply
      dependsOn: waitForValidation
      steps:
        - script: |
            cd production/control_centre
            terragrunt apply -auto-approve
          displayName: 'terraform apply'
- stage: CompletePlatform
  displayName: 'CompletePlatform'
  dependsOn: build
  jobs:
    - job: terraform_plan
      steps:
        - script: |
            cd production
            terragrunt run-all plan
          displayName: 'terraform plan'
    - job: waitForValidation
      dependsOn: terraform_plan
      displayName: Wait for external validation
      pool: server
      timeoutInMinutes: 4320 # job times out in 3 days
      steps:
        - task: ManualValidation@0
          timeoutInMinutes: 1440 # task times out in 1 day
          inputs:
            notifyUsers: |
              mccullya@gmail.com
            instructions: 'Please validate the build configuration and resume'
            onTimeout: 'reject'
    - job: terraform_apply
      dependsOn: waitForValidation
      steps:
        - script: |
            cd production/control_centre
            terragrunt run-all apply -auto-approve
          displayName: 'terraform apply'